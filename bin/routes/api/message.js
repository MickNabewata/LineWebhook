"use strict";var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)};return function(e,t){function s(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var apiBase_1=require("../apiBase"),config=require("config"),httpUtil_1=require("../../utils/httpUtil"),es6_promise_1=require("es6-promise"),Example=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.promises=[],e}return __extends(e,t),e.prototype.postEvent=function(e,t,s){var o=this;e.body&&e.body.events&&0<e.body.events.length?(e.body.events.forEach(function(e){switch(e.type){case"message":o.receiveMessage(e,t);break;case"beacon":case"follow":case"join":case"leave":case"memberJoined":case"memberLeft":case"postback":case"unfollow":default:t.statusCode=200,t.end()}}),es6_promise_1.Promise.all(this.promises).then(function(e){t.statusCode=200,t.json()},function(e){t.statusCode=e.statusCode,t.json(e.body)})):(t.statusCode=400,t.json("no message."))},e.prototype.postCheck=function(e){return e.body?"events"in e.body?null:"request body events is required.":"request body is required."},e.prototype.receiveMessage=function(e,t){var s,o;if(e&&e.message&&e.message.type)switch(e.message.type){case"text":s=config.get("worker.text"),o=e.message;break;case"image":case"video":s="",o=e.message}""!=s?this.doRequest(s,o,t):(t.statusCode=200,t.end())},e.prototype.doRequest=function(e,t,s){this.promises.push(new es6_promise_1.Promise(function(o,n){httpUtil_1.default.post(e,{json:!0,body:t,headers:{"Content-Type":"application/json"}},function(e,t,s){e||200!=t.statusCode?n({statusCode:t.statusCode,body:s}):o()})}))},e}(apiBase_1.default);exports.default=Example;